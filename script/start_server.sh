#!/bin/bash

# Uusage: bash start_server.sh NUM_WORKER ENABLE_LEMETHOD ENABLE_TSENGINE LEMETHOD_CONNECTION_TYPE
#         GREED_RATE PS_VERBOSE

NUM_WORKER=$1
ENABLE_LEMETHOD=$2
ENABLE_TSENGINE=$3
LEMETHOD_CONNECTION_TYPE=$4
# TSENGINE must with the GREED_RATE, because its codes do not check the environment variable.
GREED_RATE=$5
PS_VERBOSE=$6
ENABLE_MEMORY_CHECKER=$7

SCHEDULER_PORT=9092
PARAMETER_SERVER_PATH='./experiment.py'
SCHEDULER_ADDRESS='192.168.0.1'

# start server
export START_SERVER='python3 '$PARAMETER_SERVER_PATH
DMLC_ROLE=server \
DMLC_PS_ROOT_URI=$SCHEDULER_ADDRESS \
DMLC_PS_ROOT_PORT=$SCHEDULER_PORT \
DMLC_NUM_SERVER=1 \
DMLC_NUM_WORKER=$NUM_WORKER \
ENABLE_LEMETHOD=$ENABLE_LEMETHOD \
ENABLE_TSENGINE=$ENABLE_TSENGINE \
GREED_RATE=$GREED_RATE \
LEMETHOD_CONF_PATH=/root/lemethod.conf \
LEMETHOD_CONNECTION_TYPE=$LEMETHOD_CONNECTION_TYPE \
PS_VERBOSE=$PS_VERBOSE \
$START_SERVER >> server.log 2>&1 &
if [ "$ENABLE_MEMORY_CHECKER" == "1" ]; then
    bash memory_checker.sh "$!" "$(awk 'BEGIN {print 2.5*1024}')" &
fi
