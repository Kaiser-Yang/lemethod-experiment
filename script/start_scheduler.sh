#!/bin/bash

# Uusage: bash start_scheduler.sh NUM_WORKER ENABLE_LEMETHOD ENABLE_TSENGINE
#         LEMETHOD_CONNECTION_TYPE GREED_RATE PS_VERBOSE

NUM_WORKER=$1
ENABLE_LEMETHOD=$2
ENABLE_TSENGINE=$3
LEMETHOD_CONNECTION_TYPE=$4
# TSENGINE must with the GREED_RATE, because its codes do not check the environment variable.
GREED_RATE=$5
PS_VERBOSE=$6

SCHEDULER_PORT=9092
SCHEDULER_PATH='./experiment.py'
SCHEDULER_ADDRESS='192.168.0.1'

# start scheduler
export START_SCHEDULER='python3 '$SCHEDULER_PATH
DMLC_ROLE=scheduler \
DMLC_PS_ROOT_URI=$SCHEDULER_ADDRESS \
DMLC_PS_ROOT_PORT=$SCHEDULER_PORT \
DMLC_NUM_SERVER=1 \
DMLC_NUM_WORKER=$NUM_WORKER \
ENABLE_LEMETHOD=$ENABLE_LEMETHOD \
ENABLE_TSENGINE=$ENABLE_TSENGINE \
GREED_RATE=$GREED_RATE \
LEMETHOD_CONNECTION_TYPE=$LEMETHOD_CONNECTION_TYPE \
LEMETHOD_CONF_PATH=/root/lemethod.conf \
PS_VERBOSE=$PS_VERBOSE \
$START_SCHEDULER >> scheduler.log 2>&1 &
if [ "$ENABLE_LEMETHOD" == "1" ]; then
    bash memory_checker.sh "$!" "$(awk 'BEGIN {print 2.5*1024}')" &
fi
